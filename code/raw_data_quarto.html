<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Biomass</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="raw_data_quarto_files/libs/clipboard/clipboard.min.js"></script>
<script src="raw_data_quarto_files/libs/quarto-html/quarto.js"></script>
<script src="raw_data_quarto_files/libs/quarto-html/popper.min.js"></script>
<script src="raw_data_quarto_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="raw_data_quarto_files/libs/quarto-html/anchor.min.js"></script>
<link href="raw_data_quarto_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="raw_data_quarto_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="raw_data_quarto_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="raw_data_quarto_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="raw_data_quarto_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#opening-and-preparing-database" id="toc-opening-and-preparing-database" class="nav-link active" data-scroll-target="#opening-and-preparing-database"><span class="header-section-number">1</span> Opening and preparing database</a>
  <ul class="collapse">
  <li><a href="#checking-errors" id="toc-checking-errors" class="nav-link" data-scroll-target="#checking-errors"><span class="header-section-number">1.1</span> Checking errors</a></li>
  </ul></li>
  <li><a href="#variables" id="toc-variables" class="nav-link" data-scroll-target="#variables"><span class="header-section-number">2</span> VARIABLES</a>
  <ul class="collapse">
  <li><a href="#biomass-at-species-level" id="toc-biomass-at-species-level" class="nav-link" data-scroll-target="#biomass-at-species-level"><span class="header-section-number">2.1</span> Biomass at species level</a></li>
  <li><a href="#richness" id="toc-richness" class="nav-link" data-scroll-target="#richness"><span class="header-section-number">2.2</span> Richness</a></li>
  <li><a href="#abundance-at-community-level" id="toc-abundance-at-community-level" class="nav-link" data-scroll-target="#abundance-at-community-level"><span class="header-section-number">2.3</span> Abundance at community level</a></li>
  <li><a href="#biomass-at-community-level" id="toc-biomass-at-community-level" class="nav-link" data-scroll-target="#biomass-at-community-level"><span class="header-section-number">2.4</span> Biomass at community level</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Biomass</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="opening-and-preparing-database" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="opening-and-preparing-database"><span class="header-section-number">1</span> Opening and preparing database</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="at">all.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(dplyr, reshape2, tidyverse, lubridate, ggplot2, ggpubr, ggrepel)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#setwd("C:/Users/javier.porras/Documents/dynamics_arkaute")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strip.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>All the raw data information we have present an assymetrical distribution.</p>
<ul>
<li>Abundance</li>
<li>Morphological parameters:
<ul>
<li>Height (H, cm)</li>
<li>Diameter at half height (Dm, cm)</li>
<li>Circumference at half heiht (Cm, cm)</li>
<li>Diameter at the base (Db, cm)</li>
<li>Circumference at the base (Cb, cm)</li>
</ul></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>flora_raw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"flora_db_raw.csv"</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>flora_raw <span class="ot">&lt;-</span> flora_raw <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), as.factor))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>flora_raw<span class="sc">$</span>plot <span class="ot">&lt;-</span> <span class="fu">factor</span>(flora_raw<span class="sc">$</span>plot)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>flora_raw<span class="sc">$</span>sampling <span class="ot">&lt;-</span> <span class="fu">factor</span>(flora_raw<span class="sc">$</span>sampling, <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(flora_raw<span class="sc">$</span>sampling)))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>flora_raw<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="fu">factor</span>(flora_raw<span class="sc">$</span>treatment, <span class="at">levels =</span>  <span class="fu">c</span>(<span class="st">"c"</span>, <span class="st">"w"</span>, <span class="st">"p"</span>, <span class="st">"wp"</span>) )</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>flora_raw<span class="sc">$</span>plot <span class="ot">&lt;-</span> <span class="fu">factor</span>(flora_raw<span class="sc">$</span>plot, <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(flora_raw<span class="sc">$</span>plot)))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>flora_raw <span class="ot">&lt;-</span> <span class="fu">select</span>(flora_raw, <span class="sc">-</span>date, <span class="sc">-</span>category, <span class="sc">-</span>OBS, <span class="sc">-</span>ni.agrupado, <span class="sc">-</span>familia, <span class="sc">-</span>species_old_1, <span class="sc">-</span>species_old_2)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(flora_raw<span class="sc">$</span>abundance, <span class="at">main =</span> <span class="st">"Abundance"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(flora_raw<span class="sc">$</span>height, <span class="at">main =</span> <span class="st">"Height"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(flora_raw<span class="sc">$</span>Dm, <span class="at">main =</span> <span class="st">"Diameter half heihgt"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(flora_raw<span class="sc">$</span>Cm, <span class="at">main =</span> <span class="st">"Circumference half height"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(flora_raw<span class="sc">$</span>Db, <span class="at">main =</span> <span class="st">"Diameter at the base"</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(flora_raw<span class="sc">$</span>Cb, <span class="at">main =</span> <span class="st">"Circumference at the base"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/Opening%20database-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We add sampling dates using the package <em>lubridate</em> and the database “sampling_dates.csv” where we kept a record of all dates.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding dates</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sampling_dates <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sampling_dates.csv"</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sampling_dates<span class="sc">$</span>sampling <span class="ot">&lt;-</span> <span class="fu">factor</span>(sampling_dates<span class="sc">$</span>sampling)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sampling_dates<span class="sc">$</span>date <span class="ot">&lt;-</span>  <span class="fu">ymd</span>(sampling_dates<span class="sc">$</span>date)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>sampling_dates<span class="sc">$</span>month <span class="ot">&lt;-</span> <span class="fu">month</span>(sampling_dates<span class="sc">$</span>date, <span class="at">label =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sampling_dates<span class="sc">$</span>day <span class="ot">&lt;-</span> <span class="fu">day</span>(sampling_dates<span class="sc">$</span>date)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>sampling_dates<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">year</span>(sampling_dates<span class="sc">$</span>date)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>sampling_dates <span class="ot">&lt;-</span> sampling_dates <span class="sc">%&gt;%</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sampling, date, day, month, year, one_month_window, omw_date)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>sampling_dates <span class="ot">&lt;-</span> sampling_dates <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), as.factor))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>flora_raw <span class="ot">&lt;-</span> <span class="fu">right_join</span>(flora_raw, sampling_dates, <span class="at">by =</span> <span class="fu">join_by</span>(sampling))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>flora_rare <span class="ot">&lt;-</span> flora_raw <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampling, one_month_window, omw_date, plot, treatment, code, abundance, height, Cb, Db, Cm, Dm, date, month)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We also added species information by adding the database “species_code.csv” and merging it by “code”, which is the abrevitation we have used for the species. Each code is a word of four letters, the first two being the first two letters of the genus, and the last two letters being the first two letter os the species. Example: For the species <em>Convolvus arvensis</em> we used the code <em>coar</em>, while for the species <em>Ranunculus bulbosus</em> we used the code <em>rabu</em>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding species information</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>species_code <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"species_code.csv"</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>species_code <span class="ot">&lt;-</span> <span class="fu">select</span>(species_code, species, code, family, genus_level, species_level)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>species_code <span class="ot">&lt;-</span> species_code <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), as.factor))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>flora_rare <span class="ot">&lt;-</span> <span class="fu">merge</span>(flora_rare, species_code, <span class="at">by =</span> <span class="st">"code"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A change we had to make to the database is adding 0.01 cm to both Dm and Db since the tool we used was calibrated at -0.01 cm.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cambios de los datos morfológicos antes de agrupar la base de datos por especie, muestro y sampling </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Sumar 0.01 cm a los diámetros por el error del calibre con el que medimos</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>flora_rare<span class="sc">$</span>Dm <span class="ot">&lt;-</span> flora_rare<span class="sc">$</span>Dm <span class="sc">+</span> <span class="fl">0.01</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>flora_rare<span class="sc">$</span>Db <span class="ot">&lt;-</span> flora_rare<span class="sc">$</span>Db <span class="sc">+</span> <span class="fl">0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="checking-errors" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="checking-errors"><span class="header-section-number">1.1</span> Checking errors</h3>
<p>We have to check all possible mistakes found within the database due to errors at field or database building.</p>
<ol type="1">
<li><p>Is there any line with less than 2 NA between height, cb, cm, db and dm? This is: did we slip some extra data in some lines? The answer is: 0</p></li>
<li><p>Is there any line with more than 2 NA among the same variables? This is: are we missing some data? The answer is: 0 For this last question, I have filtered by excluding the samplings 0, 1, 2, 3 and 12. This is because during samplings 0, 1 and 2 we only measured height, for the sampling 3 (first sampling performing non-destructive methodology) we missed some individuals, and for sampling 12 we could not do biomass for several reasons.</p></li>
</ol>
<p>After that, we can check several plots in order to see the relationship between the morphological parameters and check if there is any dot that seems to be off the chart.</p>
<p>** no consigo cargar los plots</p>
</section>
</section>
<section id="variables" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="variables"><span class="header-section-number">2</span> VARIABLES</h2>
<section id="biomass-at-species-level" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="biomass-at-species-level"><span class="header-section-number">2.1</span> Biomass at species level</h3>
<ol type="1">
<li>First thing we have to do is to transform the diameters into circumferences</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Transforming diameters into circumferences</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>flora_rare<span class="sc">$</span>cm <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(flora_rare<span class="sc">$</span>Dm), flora_rare<span class="sc">$</span>Dm <span class="sc">*</span> pi, flora_rare<span class="sc">$</span>Cm), <span class="dv">2</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>flora_rare<span class="sc">$</span>cb <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(flora_rare<span class="sc">$</span>Db), flora_rare<span class="sc">$</span>Db <span class="sc">*</span> pi, flora_rare<span class="sc">$</span>Cb), <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Then, we calculate the area at base level and at half height using bot Cm and Cb</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculating area of circle with circumference values</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>flora_rare<span class="sc">$</span>Ah <span class="ot">&lt;-</span> ((flora_rare<span class="sc">$</span>cm)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">4</span><span class="sc">*</span>pi)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>flora_rare<span class="sc">$</span>Ab <span class="ot">&lt;-</span> ((flora_rare<span class="sc">$</span>cb)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">4</span><span class="sc">*</span>pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can check if there is any individual with an area bigger than 1 m<sup>2</sup></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Checking if the area of any individual is above 1 square meter</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">nrow</span>({checkingNA <span class="ot">&lt;-</span> flora_rare <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rowSums</span>(<span class="fu">is.na</span>(<span class="fu">select</span>(., height, Ah, Ab))) <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sampling <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"12"</span>))}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Agrupation of taxonomical groups and calculation of mean values for morphological values. At the first samplings, we were collecting information of all possible species. With the pass of time, we realized we could not identify every species at every sampling due to the abscence of flowers or fruits. That is why we decided to group those species into a higher taxonomical categories. This is the case of the families <em>poaceae</em>, <em>asteraceae</em>, <em>orchidaceae</em> and the genus <em>Torilis</em>. Here we calculate the abundance of these groups by summing all data of abundance per sampling and plot. Example: if we took abundance fromm a plot in the sampling 1, we might have included 5 poaceae species. That means, we are including 5 datapoints about abundance. Since we are aggregating these species into the family group, we need to sum all these abundances in order to know how much space was the poaceae group occupying at the time. It is important to mention that there are some poaceae species like <em>Dactilys glomerata</em> or <em>Festuca arundinacea</em> that we could identify. Same happens for asteraceae group. Besides, in this step we calculate the average value for height, the area at base level (Ab) and the area at half height (Ah).</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>taxongroups <span class="ot">&lt;-</span> flora_rare <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(code <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"poaceae"</span>, <span class="st">"asteraceae"</span>, <span class="st">"tosp"</span>, <span class="st">"orchidaceae"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(code, sampling, one_month_window, omw_date, plot, treatment, date, month, species, family, genus_level, species_level) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">abundance =</span> <span class="fu">sum</span>(<span class="fu">unique</span>(abundance), <span class="at">na.rm =</span> T), <span class="co">#here we sum abundances </span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">height =</span> <span class="fu">mean</span>(height, <span class="at">na.rm =</span> T),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ah =</span> <span class="fu">mean</span>(Ah, <span class="at">na.rm =</span> T),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ab =</span> <span class="fu">mean</span>(Ab, <span class="at">na.rm =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'code', 'sampling', 'one_month_window',
'omw_date', 'plot', 'treatment', 'date', 'month', 'species', 'family',
'genus_level'. You can override using the `.groups` argument.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(flora_rare, taxongroups, <span class="at">by =</span> <span class="st">"code"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(code, sampling, one_month_window, omw_date, plot, treatment, date, month, species, family, genus_level, species_level) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">abundance =</span> <span class="fu">mean</span>(abundance, <span class="at">na.rm =</span> T), <span class="co">#here we mean abundances (fake mean, species in the same plot and sampling have the same abundance info)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">height =</span> <span class="fu">mean</span>(height, <span class="at">na.rm =</span> T),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ah =</span> <span class="fu">mean</span>(Ah, <span class="at">na.rm =</span> T),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ab =</span> <span class="fu">mean</span>(Ab, <span class="at">na.rm =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'code', 'sampling', 'one_month_window',
'omw_date', 'plot', 'treatment', 'date', 'month', 'species', 'family',
'genus_level'. You can override using the `.groups` argument.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>flora_medium <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(taxongroups, species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Once we have reduced the database by calculating the mean value of height, Ah and Ab per species, plot and sampling, we have a database where in every measured plot we have 1 row per species mainly containing sampling, date, plot, treatment, species code, height, Ah, Ab. Now, we can apply the biomass equation. This way we calculate the mean individual biomass per species (biomass_i)</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fl">1.96</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>flora_medium<span class="sc">$</span>x <span class="ot">&lt;-</span> (flora_medium<span class="sc">$</span>height<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span>(flora_medium<span class="sc">$</span>Ab <span class="sc">+</span> flora_medium<span class="sc">$</span>Ah)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>flora_medium<span class="sc">$</span>biomass_i <span class="ot">&lt;-</span> d<span class="sc">*</span>(flora_medium<span class="sc">$</span>x<span class="sc">^</span>z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="richness" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="richness"><span class="header-section-number">2.2</span> Richness</h3>
<p>To add the richness information per plot and sampling, we just count the number of different species within each combination of plot and sampling.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>flora_medium <span class="ot">&lt;-</span> flora_medium <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(plot, sampling) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">richness =</span> <span class="fu">n_distinct</span>(code, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="abundance-at-community-level" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="abundance-at-community-level"><span class="header-section-number">2.3</span> Abundance at community level</h3>
<p>To calculate the abundance at community level (this is: total abundance of each plot at each sampling), we have to add the relative abundance of each species within the plots.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>flora_medium <span class="ot">&lt;-</span> flora_medium <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(plot, sampling) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">abundance_community =</span> <span class="fu">sum</span>(abundance, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>flora_abrich <span class="ot">&lt;-</span> flora_medium</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>At this point we can take a look to some plots:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/plots-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/plots-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="biomass-at-community-level" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="biomass-at-community-level"><span class="header-section-number">2.4</span> Biomass at community level</h3>
<p>The first thing to do with biomass is to filter from the database all samplings for which we do not have any information about biomass. This is sampling 0, 1, 2 and 12.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#For biomass, we do not have information for samplings 0, 1, 2 and 12. </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>flora_biomass_raw <span class="ot">&lt;-</span> flora_medium <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sampling <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"12"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="calculating-biomass-at-species-level" class="level4" data-number="2.4.1">
<h4 data-number="2.4.1" class="anchored" data-anchor-id="calculating-biomass-at-species-level"><span class="header-section-number">2.4.1</span> Calculating biomass at species level</h4>
<p>To calculate the biomass at species level (biomass_s) on a plot and sampling based on the biomass at individual level (biomass_i) we need to know the number of individuals that were on that plot for that species. biomass_i is just the mean biomass of an individual of a certain species. Therefore, we need to know the number of individuals per square metre or plot (nind_m2) in oder to know the total amount of biomass per species on a plot (biomass_s). This way biomass_s = biomass_i * nind_m2. However, the information about nind_m2 is not available for all species at all plots and samplings. Therefore, we have to estimate it based on the available information.</p>
<p>But, before that, we know that there are some species for which we only have measured 1 individual per plot and sampling every time we have spot it. Therefore, for these species we do not need to estimate the number of individuals. In this case, biomass_i = biomass_s. These species are <em>Rumex crispus</em>, <em>Amaranthus sp.</em>, <em>Kickxia supuria</em> and an unidentified species of the family <em>brasicaceae</em>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>one_ind_species <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rucr"</span>, <span class="st">"amsp"</span>, <span class="st">"kisp"</span>,<span class="st">"brasicaceae"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>flora_biomass_oneind <span class="ot">&lt;-</span> flora_biomass_raw <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(code <span class="sc">%in%</span> one_ind_species)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>flora_biomass_oneind<span class="sc">$</span>biomass_s <span class="ot">&lt;-</span> flora_biomass_oneind<span class="sc">$</span>biomass_i</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>flora_biomass_oneind <span class="ot">&lt;-</span> flora_biomass_oneind <span class="sc">%&gt;%</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sampling, plot, code) <span class="sc">%&gt;%</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_observations =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>flora_biomass_raw <span class="ot">&lt;-</span> flora_biomass_raw <span class="sc">%&gt;%</span> </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>code <span class="sc">%in%</span> one_ind_species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="estimation-of-number-of-individuals-available-data" class="level5" data-number="2.4.1.1">
<h5 data-number="2.4.1.1" class="anchored" data-anchor-id="estimation-of-number-of-individuals-available-data"><span class="header-section-number">2.4.1.1</span> Estimation of number of individuals: available data</h5>
<p>Once we have that information we can proceed to estimate the number of individuals.</p>
<p>To be able to estimate abundance based on the number of individuals we need data were abundance and number of individuals per species, plot and sampling were available. Since we have been learning the application of this non-destructive methodology on the go, we have 2 different groups of data:</p>
<ol type="1">
<li>Group 1 (nind1): Since sampling 12, we have been estimating the number of individuals per species and plot based on direct field observations.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>nind1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"n_individuals.csv"</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#source("code/first_script_old.R")</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>nind1<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nind1<span class="sc">$</span>code)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>nind1 <span class="ot">&lt;-</span> <span class="fu">select</span>(nind1, sampling, plot, code, nind_m2, abundance)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">#flora_nind &lt;-  flora %&gt;% select(code, family) %&gt;% distinct(code, .keep_all = TRUE)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>nind1 <span class="ot">&lt;-</span> nind1 <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sampling, plot, code) <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nind_m2 =</span> <span class="fu">sum</span>(nind_m2), <span class="at">abundance =</span> <span class="fu">sum</span>(abundance))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'sampling', 'plot'. You can override using
the `.groups` argument.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>nind1<span class="sc">$</span>sampling <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nind1<span class="sc">$</span>sampling)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>nind1<span class="sc">$</span>plot <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nind1<span class="sc">$</span>plot)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>nind1<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nind1<span class="sc">$</span>code)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>nind1<span class="sc">$</span>nind_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(nind1<span class="sc">$</span>nind_m2)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>nind1<span class="sc">$</span>abundance <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(nind1<span class="sc">$</span>abundance)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Las especies de asteraceae que hemos agrupado por familia se recalculan sus individuos y abundancias aquí</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Group 2 (nind2): Up to sampling 11, We only measured the morphological parameters of 5 individuals per specie as maximum. If there were less than 5 species, we know that number was the total amount of individuals in the plot.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>nind2 <span class="ot">&lt;-</span> flora_raw <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sampling <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"12"</span>, <span class="st">"13"</span>, <span class="st">"14"</span>, <span class="st">"15"</span>, <span class="st">"16"</span>, <span class="st">"17"</span>, <span class="st">"18"</span>, <span class="st">"19"</span>, <span class="st">"20"</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sampling, plot, code) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_individuals =</span> <span class="fu">n</span>())</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>nind2 <span class="ot">&lt;-</span> nind2 <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sampling, plot, code,abundance) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n_individuals_mean =</span> <span class="fu">mean</span>(n_individuals, <span class="at">na.rm =</span> T))  <span class="co">#corrección de asteraceae y poaceae #corrección de asteraceae y poaceae</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'sampling', 'plot', 'code'. You can
override using the `.groups` argument.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>nind2 <span class="ot">&lt;-</span> nind2 <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_individuals_mean <span class="sc">&lt;</span> <span class="dv">5</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(nind2)[<span class="fu">names</span>(nind2) <span class="sc">==</span> <span class="st">"n_individuals_mean"</span>] <span class="ot">&lt;-</span> <span class="st">"nind_m2"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once we have both groups, we can merge both groups by binding rows.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Mergin group 1 and group 2</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>nind <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(nind1, nind2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Question: if we have some species for which the number of individuals measured in the plot was the total amount of individuals in that plot (this is, when there were less than 5 individuals per species), why are we not calculating the biomass of those species as biomass_s = biomass_1 + biomass_2 … + biomass_i ? I think this is worthy to be considered. At the begining we did do this. But, I think we decided that, for the shake of consistency, we do not want to mix biomass_s estimation approaches for the same species. For the case of one_ind_species, these species have only been spotted isolately. Therefore, biomass_i = biomass_s is valid for these species since it will be the only approach used for them. However, if for <em>Potentilla reptans</em> we use one approach (summing individual biomass when nind &lt; 5) at certain moments and another approach (estimation of nind_m2 when nind &gt;5), the noise might be higher. <strong>We could, maybe, try it?</strong></p>
</section>
<section id="estimation-of-number-of-individuals-linear-model" class="level5" data-number="2.4.1.2">
<h5 data-number="2.4.1.2" class="anchored" data-anchor-id="estimation-of-number-of-individuals-linear-model"><span class="header-section-number">2.4.1.2</span> Estimation of number of individuals: linear model</h5>
<p>Once that we have the dataset for stablishing the estimation, we have applied a linear regression model where we plot the number of individuals per m<span class="math inline">\(^2\)</span> as a function of abundance. For the lineal regression we applied the code: lm(nind_m2 ~ abundance).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>nind<span class="sc">$</span>code <span class="ot">&lt;-</span> <span class="fu">as.character</span>(nind<span class="sc">$</span>code)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Filtering the species for which we have only one point per plot and sampling. </span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>nind <span class="ot">&lt;-</span> nind <span class="sc">%&gt;%</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>code <span class="sc">%in%</span> one_ind_species)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>code_levels <span class="ot">&lt;-</span> <span class="fu">unique</span>(nind<span class="sc">$</span>code)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>gglist <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>nind_lm_data <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">length</span>(code_levels), <span class="at">ncol =</span> <span class="dv">6</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(nind_lm_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"code"</span>, <span class="st">"intercept"</span>, <span class="st">"slope"</span>, <span class="st">"r_squared"</span>, <span class="st">"p_value"</span>, <span class="st">"n_observations"</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>nind_lm_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(nind_lm_data)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'broom' was built under R version 4.3.3</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(code_levels)) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  nind_i <span class="ot">&lt;-</span> <span class="fu">subset</span>(nind, code <span class="sc">==</span> code_levels[i])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  lm_i <span class="ot">&lt;-</span> <span class="fu">lm</span>(nind_m2 <span class="sc">~</span> abundance, <span class="at">data =</span> nind_i)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coefficients, R^2, and p-value</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  lm_i_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(lm_i)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  lm_i_tidy <span class="ot">&lt;-</span> <span class="fu">tidy</span>(lm_i)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  lm_i_glance <span class="ot">&lt;-</span> <span class="fu">glance</span>(lm_i)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  intercept_i <span class="ot">&lt;-</span> lm_i_tidy<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  slope_i <span class="ot">&lt;-</span> lm_i_tidy<span class="sc">$</span>estimate[<span class="dv">2</span>]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  r_squared_i <span class="ot">&lt;-</span> lm_i_glance<span class="sc">$</span>r.squared</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  p_value_i <span class="ot">&lt;-</span> lm_i_tidy<span class="sc">$</span>p.value[<span class="dv">2</span>]</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  n_observations_i <span class="ot">&lt;-</span> <span class="fu">nrow</span>(nind_i)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  counter <span class="ot">&lt;-</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  gglist[[counter]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(nind_i, <span class="fu">aes</span>(<span class="at">x =</span> abundance, <span class="at">y =</span> nind_m2)) <span class="sc">+</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Linear Relationship for"</span>, code_levels[i]),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Equation: y ="</span>, <span class="fu">round</span>(intercept_i, <span class="dv">2</span>), <span class="st">"+"</span>, <span class="fu">round</span>(slope_i, <span class="dv">2</span>), <span class="st">"* x</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"R^2:"</span>, <span class="fu">round</span>(r_squared_i, <span class="dv">2</span>), <span class="st">", p-value:"</span>, <span class="fu">round</span>(p_value_i, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"Number of observations"</span>, n_observations_i),</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Abundance"</span>,</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Numbers of individual per m2"</span>) <span class="sc">+</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  nind_lm_data<span class="sc">$</span>code[counter] <span class="ot">&lt;-</span> code_levels[i]</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  nind_lm_data<span class="sc">$</span>intercept[counter] <span class="ot">&lt;-</span> intercept_i</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  nind_lm_data<span class="sc">$</span>slope[counter] <span class="ot">&lt;-</span> slope_i</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  nind_lm_data<span class="sc">$</span>r_squared[counter] <span class="ot">&lt;-</span> r_squared_i</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  nind_lm_data<span class="sc">$</span>p_value[counter] <span class="ot">&lt;-</span> p_value_i</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>  nind_lm_data<span class="sc">$</span>n_observations[counter] <span class="ot">&lt;-</span> n_observations_i</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gglist[[<span class="dv">6</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/linear%20regression1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, for this example the R<span class="math inline">\(^2\)</span> is quite low ( R<span class="math inline">\(^2\)</span> = 0.23). The fact is that, if we take a look to how well the model fit for all of our species, there are many considerations to evaluate.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>nind_lm_data<span class="sc">$</span>posneg_slope <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nind_lm_data<span class="sc">$</span>slope <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="fu">paste</span>(<span class="st">"negative"</span>), <span class="fu">paste</span>(<span class="st">"positive"</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#hist(nind_lm_data$slope)</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's check results</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(nind_lm_data, <span class="fu">aes</span>( <span class="at">x =</span> r_squared, <span class="at">y =</span> p_value, </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> <span class="fu">paste</span>(code, n_observations, <span class="at">sep =</span> <span class="st">", "</span>), <span class="at">color =</span> posneg_slope))<span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>,                <span class="co"># Text size</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.1</span>,  <span class="co"># Ensures lines are always drawn</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.color =</span> <span class="st">"gray50"</span>,<span class="co"># Line color</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.5</span>, </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="dv">15</span><span class="co"># Line thickness</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: ggrepel: 3 unlabeled data points (too many overlaps). Consider
increasing max.overlaps</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/linear%20regression2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#The lm model fits well (R^2 &gt;= 0.3 and p-value &lt; 0.1) for a few species: </span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !! Why do we choose R2 0.3?</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>species_lm<span class="ot">&lt;-</span> nind_lm_data <span class="sc">%&gt;%</span> </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(r_squared <span class="sc">&gt;</span> <span class="fl">0.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_value <span class="sc">&lt;</span> <span class="fl">0.1</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>species_lm_codes <span class="ot">&lt;-</span> <span class="fu">unique</span>(species_lm<span class="sc">$</span>code)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>nind_lm_species <span class="ot">&lt;-</span> nind_lm_data <span class="sc">%&gt;%</span> </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(code <span class="sc">%in%</span> species_lm_codes )</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>excluded_species_lm <span class="ot">&lt;-</span> {nind_lm_data <span class="sc">%&gt;%</span> </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>code <span class="sc">%in%</span> species_lm_codes )}<span class="sc">$</span>code</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>flora_nobs<span class="sc">$</span>excluded <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(flora_nobs<span class="sc">$</span>code <span class="sc">%in%</span> excluded_species_lm, <span class="st">"excluded"</span>, <span class="st">"included"</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the plot</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(flora_nobs, <span class="fu">aes</span>(<span class="at">x =</span> mean_abundance, <span class="at">y =</span> n_observations, <span class="at">label =</span> code)) <span class="sc">+</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> excluded)) <span class="sc">+</span>  <span class="co"># Color based on the exclusion status</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"included"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"excluded"</span> <span class="ot">=</span> <span class="st">"red"</span>)  <span class="co"># Specify colors</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>,                <span class="co"># Text size</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.1</span>,  <span class="co"># Ensures lines are always drawn</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.color =</span> <span class="st">"gray50"</span>,  <span class="co"># Line color</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.5</span>         <span class="co"># Line thickness</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"LM inclusion"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: ggrepel: 6 unlabeled data points (too many overlaps). Consider
increasing max.overlaps</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="raw_data_quarto_files/figure-html/linear%20regression3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">length</span>(species_lm_codes)<span class="sc">+</span> <span class="fu">length</span>(one_ind_species))<span class="sc">/</span>(<span class="fu">length</span>(<span class="fu">unique</span>(flora_raw<span class="sc">$</span>code))) <span class="sc">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 51.21951</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#51% of species have been excluded from biomass</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>flora_biomass_lm <span class="ot">&lt;-</span> <span class="fu">merge</span>(flora_biomass_raw, nind_lm_species)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">#calculation of number of indivuals per m2 with the regression data for each species</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>flora_biomass_lm<span class="sc">$</span>nind_m2 <span class="ot">&lt;-</span> flora_biomass_lm<span class="sc">$</span>intercept <span class="sc">+</span> flora_biomass_lm<span class="sc">$</span>abundance <span class="sc">*</span> flora_biomass_lm<span class="sc">$</span>slope</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Since there are some species for which its intercept is negative, the lm consider that nind_m2 &lt;0 when abundance = 0. And that</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># cannot be the case. There are 3 species. We can either delete these species or make this "shitty" correction by sayin that if</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># nind_m2 &lt; 0 , then nind_m2 = 0</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Shitty correction ?????????????????????????????????????</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>flora_biomass_lm <span class="ot">&lt;-</span> flora_biomass_lm <span class="sc">%&gt;%</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nind_m2 =</span> <span class="fu">ifelse</span>(nind_m2 <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="fl">0.1</span>, nind_m2))</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculation of species biomass per square meter by multiplying biomass at individual (biomass_i) level by the </span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># number of individuals per square meter (nind_m2)</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>flora_biomass_lm<span class="sc">$</span>biomass_s <span class="ot">&lt;-</span> flora_biomass_lm<span class="sc">$</span>biomass_i <span class="sc">*</span> flora_biomass_lm<span class="sc">$</span>nind_m2</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="co">#Putting together lm species and one ind species</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>flora_biomass <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(flora_biomass_oneind, flora_biomass_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>